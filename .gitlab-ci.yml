# GitLab CI/CD Pipeline for GrimRepo Scripts (ReScript + WASM)
# RSR Bronze Compliance

variables:
  NODE_VERSION: "20"

# Stages
stages:
  - build
  - validate
  - security
  - deploy

# Build ReScript
build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - npm install -g rescript@latest
    - rescript build
    - ls -lah src/*.bs.js lib/
  artifacts:
    paths:
      - src/*.bs.js
      - lib/
    expire_in: 7 days
  allow_failure: false

# RSR compliance verification
rsr-compliance:
  stage: validate
  image: alpine:latest
  script:
    - echo "ðŸ… Verifying RSR Bronze Compliance..."
    - |
      check_file() {
        if [ -f "$1" ]; then
          echo "  âœ“ $1"
          return 0
        else
          echo "  âœ— $1 (MISSING)"
          return 1
        fi
      }

      FAILED=0

      echo ""
      echo "ðŸ“„ Required Documentation:"
      check_file "README.md" || FAILED=1
      check_file "LICENSE.txt" || FAILED=1
      check_file "SECURITY.md" || FAILED=1
      check_file "CONTRIBUTING.md" || FAILED=1
      check_file "CODE_OF_CONDUCT.md" || FAILED=1
      check_file "MAINTAINERS.md" || FAILED=1
      check_file "CHANGELOG.md" || FAILED=1

      echo ""
      echo "ðŸ” .well-known Directory:"
      check_file ".well-known/security.txt" || FAILED=1
      check_file ".well-known/ai.txt" || FAILED=1
      check_file ".well-known/humans.txt" || FAILED=1

      echo ""
      echo "ðŸ› ï¸  Build System:"
      check_file "bsconfig.json" || FAILED=1
      check_file "justfile" || FAILED=1
      check_file "flake.nix" || FAILED=1

      echo ""
      echo "ðŸ“¦ ReScript Source:"
      check_file "src/GrimRepo.res" || FAILED=1
      check_file "src/GrimRepoTypes.res" || FAILED=1
      check_file "src/Bootstrap.res" || FAILED=1
      check_file "src/Community.res" || FAILED=1
      check_file "src/Audit.res" || FAILED=1

      echo ""
      echo "ðŸ”„ CI/CD:"
      check_file ".gitlab-ci.yml" || FAILED=1

      echo ""
      if [ $FAILED -eq 0 ]; then
        echo "âœ… RSR Bronze Compliance: PASSED"
        exit 0
      else
        echo "âŒ RSR Bronze Compliance: FAILED"
        exit 1
      fi
  allow_failure: false

# Code quality check
code-quality:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - npm install -g rescript@latest
    - rescript format -all -check
  allow_failure: true

# Security: Secret Detection
secret_detection:
  stage: security
  variables:
    SECRET_DETECTION_ENABLED: 'true'

# Pages (documentation)
pages:
  stage: deploy
  image: alpine:latest
  script:
    - mkdir -p public
    - |
      cat > public/index.html <<EOF
      <!DOCTYPE html>
      <html>
      <head>
        <title>GrimRepo Scripts - ReScript + WASM</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
          h1 { color: #333; }
          .badge { display: inline-block; padding: 5px 10px; background: #4caf50; color: white; border-radius: 3px; margin: 5px; }
          .tech { background: #2196f3; }
        </style>
      </head>
      <body>
        <h1>ðŸ“Š GrimRepo Scripts</h1>
        <p>
          <span class="badge">RSR Bronze Compliant</span>
          <span class="badge tech">ReScript</span>
          <span class="badge tech">WASM-Ready</span>
        </p>
        <h2>Architecture:</h2>
        <ul>
          <li><strong>Core Logic</strong>: ReScript (type-safe, functional)</li>
          <li><strong>Performance</strong>: WASM compilation target</li>
          <li><strong>Glue Code</strong>: Minimal JavaScript</li>
          <li><strong>Zero Runtime Dependencies</strong>: Offline-first</li>
        </ul>
        <p>Generated by GitLab CI/CD</p>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main

# Include GitLab security templates
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
